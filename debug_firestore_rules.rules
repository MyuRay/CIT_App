rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // デバッグ用: 一時的に全体通知を緩い権限に設定
    match /global_notifications/{notificationId} {
      // 読み取り：認証済みCITユーザーなら誰でも
      allow read: if isCITUser();
      
      // 作成・更新・削除：一時的に認証済みCITユーザーなら誰でも（デバッグ用）
      allow write: if isCITUser();
    }
    
    // 管理者権限のルール - デバッグ用に権限を緩める
    match /admin_permissions/{adminId} {
      // 読み取り：認証済みCITユーザーなら誰でも（デバッグ用）
      allow read: if isCITUser();
      
      // 作成・更新：認証済みCITユーザーなら誰でも（デバッグ用）
      allow create, update: if isCITUser() && hasRequiredAdminPermissionFields();
      
      // 削除：認証済みCITユーザーなら誰でも（デバッグ用）
      allow delete: if isCITUser();
    }
    
    // その他のルール（既存のまま）
    match /bulletin_posts/{postId} {
      allow read: if isValidCITUser();
      allow create: if isValidCITUser();
      allow update: if isValidCITUser() && (isOwner(resource) || isViewCountOnlyUpdate());
      allow delete: if isValidCITUser() && isOwner(resource);
    }
    
    match /bulletin_comments/{commentId} {
      allow read: if isCITUser();
      allow create: if isCITUser() 
        && request.auth != null
        && request.resource.data.authorId == request.auth.uid
        && hasRequiredCommentFields();
      allow update, delete: if isCITUser() 
        && request.auth != null
        && resource.data.authorId == request.auth.uid;
    }
    
    match /notifications/{notificationId} {
      allow read: if isCITUser() 
        && request.auth != null
        && resource.data.userId == request.auth.uid;
      allow create: if isCITUser() 
        && request.auth != null
        && hasRequiredNotificationFields();
      allow update: if isCITUser() 
        && request.auth != null
        && resource.data.userId == request.auth.uid;
      allow delete: if isCITUser() 
        && request.auth != null
        && resource.data.userId == request.auth.uid;
    }
    
    match /user_tokens/{userId} {
      allow read, write: if isCITUser() 
        && request.auth != null
        && userId == request.auth.uid;
    }
    
    match /bus_information/{document} {
      allow read: if isCITUser();
      allow write: if isCITUser();
    }
    
    match /bus_information/{busId}/operation_periods/{periodId} {
      allow read: if isCITUser();
      allow write: if isCITUser();
    }
    
    match /bus_information/{busId}/bus_routes/{routeId} {
      allow read: if isCITUser();
      allow write: if isCITUser();
    }
    
    match /users/{userId} {
      allow read: if isCITUser();
      allow write: if isCITUser() && request.auth.uid == userId;
    }
    
    match /schedules/{scheduleId} {
      allow read: if isCITUser() 
        && request.auth != null
        && resource.data.userId == request.auth.uid;
      allow create: if isCITUser() 
        && request.auth != null
        && request.resource.data.userId == request.auth.uid
        && hasRequiredScheduleFields();
      allow update: if isCITUser() 
        && request.auth != null
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid;
      allow delete: if isCITUser() 
        && request.auth != null
        && resource.data.userId == request.auth.uid;
    }
    
    match /contacts/{contactId} {
      allow create: if isCITUser() && request.resource.data.userId == request.auth.uid;
      allow read: if isCITUser();
      allow update: if isCITUser();
    }
    
    // CITユーザー判定関数（修正版）
    function isCITUser() {
      return request.auth != null 
        && request.auth.token.email != null
        && (request.auth.token.email.matches('.*@s\\.chibakoudai\\.jp$') ||
            request.auth.token.email.matches('.*@p\\.chibakoudai\\.jp$'));
    }
    
    function isValidCITUser() {
      return isCITUser();
    }
    
    function isOwner(resource) {
      return request.auth != null && resource.data.authorId == request.auth.uid;
    }
    
    function isViewCountOnlyUpdate() {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly(['viewCount']);
    }
    
    function hasRequiredCommentFields() {
      return request.resource.data.keys().hasAll(['postId', 'content', 'authorId', 'authorName', 'createdAt'])
        && request.resource.data.postId is string
        && request.resource.data.content is string
        && request.resource.data.authorId is string
        && request.resource.data.authorName is string
        && request.resource.data.createdAt is timestamp;
    }
    
    function hasRequiredNotificationFields() {
      return request.resource.data.keys().hasAll(['userId', 'type', 'title', 'message', 'createdAt'])
        && request.resource.data.userId is string
        && request.resource.data.type is string
        && request.resource.data.title is string
        && request.resource.data.message is string
        && request.resource.data.createdAt is timestamp;
    }
    
    function hasRequiredScheduleFields() {
      return request.resource.data.keys().hasAll(['id', 'userId', 'semester', 'timetable', 'timeSlots', 'createdAt'])
        && request.resource.data.id is string
        && request.resource.data.userId is string
        && request.resource.data.semester is string
        && request.resource.data.timetable is map
        && request.resource.data.timeSlots is map
        && request.resource.data.createdAt is timestamp;
    }
    
    function hasRequiredAdminPermissionFields() {
      return request.resource.data.keys().hasAll(['userId', 'isAdmin'])
        && request.resource.data.userId is string
        && request.resource.data.isAdmin is bool;
    }
  }
}